<div class="card p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">
        {{ selectedTrip ? 'Stock Allocation' : 'Trips' }}
      </h1>
      <p class="text-gray-600">
        {{ selectedTrip ? 'Manage stock allocation for this trip' : 'Create, start, and complete delivery trips' }}
      </p>
    </div>
    <p-button *ngIf="!selectedTrip" label="Create New Trip" icon="pi pi-plus" severity="success"
      (onClick)="showCreateDialog()" class="p-button-rounded">
    </p-button>
    <p-button *ngIf="selectedTrip" label="Back to Trips" icon="pi pi-arrow-left" severity="secondary"
      (onClick)="clearSelectedTrip()">
    </p-button>
  </div>

  <!-- Trips table shows only when no trip is selected -->
  <p-card *ngIf="!selectedTrip">
    <p-table [value]="trips" [scrollable]="true" [loading]="isLoadingTrips" stripedRows showGridlines
      scrollHeight="flex" [tableStyle]="{'min-width': '80rem'}">
      <ng-template pTemplate="header">
        <tr>
          <th>Driver</th>
          <th>Vehicle</th>
          <th>Route</th>
          <th>Start Time</th>
          <th>Start KM</th>
          <th>End KM</th>
          <th>Total KM</th>
          <th>Duration</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-trip>
        <!-- <pre>{{trip | json}}</pre> -->
        <tr class="hover:bg-gray-50">
          <td class="font-medium">{{ trip?.distributor?.displayName }}</td>
          <td>{{ trip.vehicle.regNo }}</td>
          <td>{{ trip.route.name }}</td>
          <td>{{ trip?.startTime ? (trip.startTime | timestampMillis | date:'dd/MM/yyyy HH:mm') : '—' }}</td>
          <td class="text-right">{{ trip.startOdometerReading | number }}</td>
          <td class="text-right">{{ trip.endOdometerReading ? (trip.endOdometerReading | number) : '—' }}</td>
          <td class="text-right font-semibold text-blue-600">{{ trip.totalKm ? (trip.totalKm | number) + ' km' : '—' }}
          </td>
          <td>{{ trip?.endTime ? (getDuration(trip.startTime, trip.endTime)) : '—' }}</td>
          <td>
            <span [ngClass]="getStatusClass(trip.status)" class="px-3 py-1 rounded-full text-xs font-medium">
              {{ trip.status }}
            </span>
          </td>
          <td>
            <div class="flex space-x-2">
              <!-- Allocate/View Stock Button for all statuses -->
              <p-button icon="pi pi-box" [severity]="trip.status === 'PENDING' ? 'info' : 'secondary'" size="small"
                rounded [pTooltip]="trip.status === 'PENDING' ? 'Allocate Stock' : 'View Stock'"
                (onClick)="selectTripForAllocation(trip)">
              </p-button>

              <!-- PENDING → Start -->
              <p-button *ngIf="trip.status === 'PENDING'" icon="pi pi-play" severity="success" size="small" rounded
                pTooltip="Start Trip" (onClick)="showStartDialog(trip)">
              </p-button>

              <!-- ONGOING → End -->
              <p-button *ngIf="trip.status === 'ONGOING'" icon="pi pi-stop" severity="warn" size="small" rounded
                pTooltip="End Trip" (onClick)="showEndDialog(trip)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center py-20">
            <div class="flex flex-col items-center gap-6 text-gray-500">
              <i class="pi pi-box text-8xl opacity-30"></i>
              <div class="text-center">
                <p class="text font-medium mb-2">No trips recorded yet.</p>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Stock Allocation View shows when trip selected -->
  <div *ngIf="selectedTrip">
    <!-- Trip Info Banner -->
    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-center justify-between">
        <div class="grid grid-cols-4 gap-6 flex-1">
          <div>
            <p class="text-xs text-blue-600 font-medium uppercase mb-1">Driver</p>
            <p class="text-base font-semibold text-blue-900">{{ selectedTrip.distributor.displayName }}</p>
          </div>
          <div>
            <p class="text-xs text-blue-600 font-medium uppercase mb-1">Route</p>
            <p class="text-base font-semibold text-blue-900">{{ selectedTrip.route.name }}</p>
          </div>
          <div>
            <p class="text-xs text-blue-600 font-medium uppercase mb-1">Vehicle</p>
            <p class="text-base font-semibold text-blue-900">{{ selectedTrip.vehicle.regNo }} <span
                class="text-sm text-gray-600">({{ selectedTrip.vehicle.model }})</span></p>
          </div>
          <div>
            <p class="text-xs text-blue-600 font-medium uppercase mb-1">Trip Status</p>
            <span [ngClass]="getStatusClass(selectedTrip.status)"
              class="inline-block px-3 py-1 rounded-full text-xs font-medium">
              {{ selectedTrip.status }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stock Allocation Component -->
    <app-trip-stock-allocation [selectedTrip]="selectedTrip"></app-trip-stock-allocation>
  </div>

  <!-- Create Trip Dialog -->
  <p-dialog header="Create New Trip" [(visible)]="visibleCreateDialog" [modal]="true" [style]="{width:'32rem'}">
    <form [formGroup]="createForm" (ngSubmit)="createTrip()" class="space-y-6">
      <div class="grid gap-5">
        <div class="flex flex-col gap-2">
          <label class="font-medium">Driver <span class="text-red-600">*</span></label>
          <p-select [options]="distributors" formControlName="userId" optionLabel="displayName" optionValue="uid"
            placeholder="Select driver" class="w-full"></p-select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="font-medium">Route <span class="text-red-600">*</span></label>
          <p-select [options]="routes" formControlName="routeId" optionLabel="name" optionValue="id"
            placeholder="Select route" class="w-full"></p-select>
        </div>

        <div class="flex flex-col gap-2">
          <label class="font-medium">Vehicle <span class="text-red-600">*</span></label>
          <p-select [options]="vehicles" formControlName="vehicleId" optionLabel="regNo" optionValue="id"
            placeholder="Select vehicle" class="w-full"></p-select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="font-medium">Starting Odometer <span class="text-red-600">*</span></label>
          <input pInputText type="number" formControlName="startOdometerReading" placeholder="e.g. 54320"
            class="w-full" />
        </div>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="visibleCreateDialog=false"
        class="p-button-text"></p-button>
      <p-button label="Create Trip" icon="pi pi-check" severity="success" [loading]="isCreatingTrip"
        (onClick)="createTrip()" [disabled]="createForm.invalid || isCreatingTrip"></p-button>
    </ng-template>
  </p-dialog>

  <!-- Start Trip Confirmation -->
  <p-dialog header="Start Trip Now?" [(visible)]="visibleStartDialog" [modal]="true" [style]="{width:'28rem'}">
    <p>Ready to begin trip to <strong>{{ activeTrip?.route?.name }}</strong>?</p>
    <p class="mt-3">Odometer: <strong>{{ activeTrip?.startOdometerReading | number }}</strong></p>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="visibleStartDialog=false"
        class="p-button-text"></p-button>
      <p-button label="Start Now" icon="pi pi-play" [loading]="isStartingTrip" [disabled]="isStartingTrip"
        severity="success" (onClick)="startTrip()"></p-button>
    </ng-template>
  </p-dialog>

  <!-- End Trip Dialog -->
  <p-dialog header="End Trip" [(visible)]="visibleEndDialog" [modal]="true" [style]="{width:'28rem'}">
    <form [formGroup]="endForm" (ngSubmit)="endTrip()">
      <p><strong>Route:</strong> {{ selectedTrip?.route?.name }}</p>
      <p><strong>Start KM:</strong> {{ selectedTrip?.startOdometerReading | number }}</p>
      <div class="flex flex-col gap-2 mt-4">
        <label class="font-medium">Ending Odometer <span class="text-red-600">*</span></label>
        <input pInputText type="number" formControlName="endOdometerReading" placeholder="Enter the current kilometer readings on the odometer" class="w-full" />
      </div>

            <!-- Actual Cash Collected -->
      <div class="flex flex-col gap-2 mt-2">
        <label class="font-medium">Actual Cash Collected <span class="text-red-600">*</span></label>
        <input 
        pInputText
          formControlName="actualCashSubmission" 
          type="number"
          placeholder="Enter the amount received from the rider"
          class="w-full"
        />
        @if (endForm.get('actualCashSubmission')?.invalid && endForm.get('actualCashSubmission')?.touched) {
          <small class="text-red-500">Actual amount collected is required</small>
        }
      </div>

    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="visibleEndDialog=false" class="p-button-text"></p-button>
      <p-button label="End Trip" icon="pi pi-stop" severity="warn" (onClick)="endTrip()" [loading]="isEndingTrip"
        [disabled]="endForm.invalid || isEndingTrip"></p-button>
    </ng-template>
  </p-dialog>

  <p-toast></p-toast>
</div>