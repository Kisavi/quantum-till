<!-- Trip Selection View -->
<div *ngIf="showTripSelection" class="min-h-screen bg-gray-50 pb-6">
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 md:p-6 shadow-lg">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl md:text-3xl font-bold mb-2">My Trips</h1>
      <p class="text-blue-100 text-sm md:text-base">Select a trip to view dashboard</p>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Loading State -->
    <div *ngIf="isLoadingTrips" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <app-loader-skeleton *ngFor="let _ of [].constructor(3)"></app-loader-skeleton>
    </div>

    <!-- Error State -->
    <p-card *ngIf="hasError && !isLoadingTrips">
      <div class="text-center py-8">
        <i class="pi pi-exclamation-triangle text-6xl text-orange-500 mb-4"></i>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">{{ errorMessage }}</h2>
        <p class="text-gray-600 mt-4">Please contact your administrator for assistance.</p>
      </div>
    </p-card>

    <!-- Trip Cards -->
    <div *ngIf="!isLoadingTrips && !hasError" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <p-card *ngFor="let trip of userTrips" class="shadow-sm hover:shadow-md transition-shadow">
        <div class="space-y-3">
          <!-- Status Badge -->
          <div class="flex justify-between items-start">
            <p-tag [value]="trip.status" [severity]="getTripStatusSeverity(trip.status)">
            </p-tag>
          </div>

          <!-- Trip Info -->
          <div class="space-y-2">
            <div>
              <span class="text-xs text-gray-600">Route</span>
              <p class="font-semibold text-gray-900">{{ trip.route.name }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">Vehicle</span>
              <p class="text-sm text-gray-700">{{ trip.vehicle.regNo }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">Date</span>
              <p class="text-sm text-gray-700">{{ (trip.startTime | timestampMillis | date:'dd/MM/yyyy HH:mm') }}</p>
            </div>
          </div>

          <!-- Action Button -->
          <div class="pt-3 border-t">
            <p-button label="View Dashboard" icon="pi pi-chart-line" [outlined]="true" severity="info"
              (onClick)="selectTrip(trip)" class="w-full">
            </p-button>
            <p *ngIf="trip.status === 'ENDED'" class="text-xs text-gray-500 text-center mt-2">
              Trip has ended
            </p>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Empty State -->
    <p-card *ngIf="!isLoadingTrips && !hasError && userTrips.length === 0">
      <div class="text-center py-12">
        <i class="pi pi-inbox text-6xl text-gray-400 mb-4"></i>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">No Trips Yet</h2>
        <p class="text-gray-500">You don't have any trips assigned yet.</p>
        <p class="text-sm text-gray-400 mt-2">Contact your administrator to get started.</p>
      </div>
    </p-card>
  </div>
</div>

<!-- Dashboard View -->
<div *ngIf="!showTripSelection" class="min-h-screen bg-gray-50 pb-6">
  <!-- Header Section -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 md:p-6 shadow-lg">
    <div class="max-w-7xl mx-auto">
      <!-- Back Button -->
      <p-button icon="pi pi-arrow-left" [text]="true" severity="secondary" (onClick)="backToTripSelection()"
        class="mb-3 text-white">
      </p-button>

      <!-- Loading State -->
      <ng-container *ngIf="isLoadingTrip">
        <app-loader-skeleton></app-loader-skeleton>
      </ng-container>

      <!-- Loaded State -->
      <ng-container *ngIf="!isLoadingTrip && summary">
        <div class="flex items-center justify-between mb-2">
          <h1 class="text-2xl md:text-3xl font-bold">Dashboard</h1>
          <span [ngClass]="getStatusClass(summary.tripStatus)" class="px-3 py-1 rounded-full text-xs font-semibold">
            {{ summary.tripStatus }}
          </span>
        </div>
        <p class="text-blue-100 text-sm md:text-base">
          {{ summary.userName }} • {{ summary.routeName }} • {{ summary.vehicleRegNo }}
        </p>
      </ng-container>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="hasError && !isLoading" class="max-w-7xl mx-auto px-4 py-8">
    <p-card>
      <div class="text-center py-8">
        <i class="pi pi-exclamation-triangle text-6xl text-red-500 mb-4"></i>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">{{ errorMessage }}</h2>
        <p class="text-gray-600 mb-4">Unable to load dashboard data</p>
        <p-button label="Retry" icon="pi pi-refresh" (onClick)="loadDashboard()">
        </p-button>
      </div>
    </p-card>
  </div>

  <!-- Main Content -->
  <div *ngIf="!hasError" class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Quick Action Buttons -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <div>
        <p-button label="Record Sale" [disabled]="selectedTrip?.status === 'ENDED'" icon="pi pi-shopping-cart"
          severity="success" [outlined]="true" (onClick)="navigateToSales()" class="w-full">
        </p-button>
      </div>
      <div>
        <p-button label="Record Return" [disabled]="selectedTrip?.status === 'ENDED'" icon="pi pi-replay"
          severity="danger" [outlined]="true" (onClick)="navigateToReturns()" class="w-full">
        </p-button>
      </div>
      <div class="col-span-2 md:col-span-1">
        <p-button label="Add Expense" [disabled]="selectedTrip?.status === 'ENDED'" icon="pi pi-wallet" severity="info"
          [outlined]="true" (onClick)="navigateToExpenses()" class="w-full">
        </p-button>
      </div>
    </div>



    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
      <!-- Initial Stock Value -->
      <p-card class="shadow-sm bg-blue-50">
        <ng-container *ngIf="isLoading">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoading && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Initial Value</div>
          <div class="text-lg md:text-xl font-bold text-blue-700 whitespace-nowrap">
            {{ summary.initialStockValue | currency:'KES ':'symbol':'1.0-0' }}
          </div>
          <div class="text-xs text-gray-500 mt-1">allocated</div>
        </ng-container>
      </p-card>

      <!-- Net Sales -->
      <p-card class="shadow-sm">
        <ng-container *ngIf="isLoadingSales">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoadingSales && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Net Sales</div>
          <div class="text-lg md:text-xl font-bold text-green-600 whitespace-nowrap">
            {{ summary.netSales | currency:'KES ':'symbol':'1.0-0' }}
          </div>
          <div class="text-xs text-gray-500 mt-1">sold</div>
        </ng-container>
      </p-card>

      <!-- Remaining Stock Value -->
      <p-card class="shadow-sm bg-purple-50">
        <ng-container *ngIf="isLoading">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoading && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Remaining Value</div>
          <div class="text-lg md:text-xl font-bold text-purple-700 whitespace-nowrap">
            {{ summary.remainingStockValue | currency:'KES ':'symbol':'1.0-0' }}
          </div>
          <div class="text-xs text-gray-500 mt-1">to return</div>
        </ng-container>
      </p-card>

      <!-- Commission -->
      <p-card class="shadow-sm">
        <ng-container *ngIf="isLoadingAllocations">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoadingAllocations && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Commission</div>
          <div class="text-lg md:text-xl font-bold text-blue-600 whitespace-nowrap">
            {{ summary.commissionEarned | currency:'KES ':'symbol':'1.0-0' }}
          </div>
          <div class="text-xs text-gray-500 mt-1">earned</div>
        </ng-container>
      </p-card>

      <!-- Personal Expenses -->
      <p-card class="shadow-sm">
        <ng-container *ngIf="isLoadingReturns">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoadingReturns && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Personal Expenses</div>
          <div class="text-lg md:text-xl font-bold text-orange-600 whitespace-nowrap">
            {{ summary.personalExpenses | currency:'KES ':'symbol':'1.0-0' }}
          </div>
          <div class="text-xs text-gray-500 mt-1">incurred</div>
        </ng-container>
      </p-card>

      <!-- Stock Sold Percentage -->
      <p-card class="shadow-sm bg-green-50">
        <ng-container *ngIf="isLoading">
          <app-loader-skeleton></app-loader-skeleton>
        </ng-container>
        <ng-container *ngIf="!isLoading && summary">
          <div class="text-xs md:text-sm text-gray-600 font-medium mb-1 whitespace-nowrap">Stock Sold</div>
          <div class="text-lg md:text-xl font-bold text-green-700 whitespace-nowrap">{{ summary.stockSoldPercentage }}%
          </div>
          <div class="text-xs text-gray-500 mt-1">of total</div>
        </ng-container>
      </p-card>
    </div>

    <!-- Product Breakdown -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4 border-b">
          <h2 class="text-lg md:text-xl font-bold text-gray-800">Stock Breakdown</h2>
        </div>
      </ng-template>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="p-4 space-y-3">
        <app-loader-skeleton *ngFor="let _ of [].constructor(5)"></app-loader-skeleton>
      </div>

      <!-- Desktop Table View -->
      <div *ngIf="!isLoading && summary" class="hidden md:block">
        <p-table [value]="summary.productSummaries" [scrollable]="true" scrollHeight="400px"
          styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Product</th>
              <th class="text-right">Unit Price</th>
              <th class="text-right">Allocated</th>
              <th class="text-right">Sold</th>
              <th class="text-right">Returned</th>
              <th class="text-right">Remaining</th>
              <th class="text-right">Sales Value</th>
              <th class="text-right">Returns Value</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-product>
            <tr>
              <td class="font-medium">{{ product.product.name }}</td>
              <td class="text-right text-gray-700">{{ product.product.unitPrice | currency:'KES ':'symbol':'1.2-2' }}
              </td>
              <td class="text-right">{{ formatQuantity(product.allocated, product.product) }}</td>
              <td class="text-right text-green-600 font-semibold">{{ formatQuantity(product.sold, product.product) }}
              </td>
              <td class="text-right text-orange-600">{{ formatQuantity(product.returned, product.product) }}</td>
              <td class="text-right text-purple-600 font-semibold">{{ formatQuantity(product.remaining, product.product)
                }}</td>
              <td class="text-right font-semibold">{{ product.salesValue | currency:'KES':'symbol':'1.2-2' }}</td>
              <td class="text-right font-semibold text-orange-600">{{ product.returnsValue |
                currency:'KES':'symbol':'1.2-2' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                <i class="pi pi-inbox text-4xl mb-2"></i>
                <p>No products allocated</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Mobile Card View -->
      <div *ngIf="!isLoading && summary" class="block md:hidden space-y-3 p-4">
        <div *ngFor="let product of summary.productSummaries" class="border rounded-lg p-4 bg-white shadow-sm">
          <h3 class="font-semibold text-gray-800 mb-1">{{ product.product.name }}</h3>
          <p class="text-sm text-gray-600 mb-3">{{ product.product.unitPrice | currency:'KES':'symbol':'1.2-2' }} per
            packet</p>

          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>
              <span class="text-gray-600">Allocated:</span>
              <span class="font-semibold ml-1">{{ formatQuantity(product.allocated, product.product) }}</span>
            </div>
            <div>
              <span class="text-gray-600">Sold:</span>
              <span class="font-semibold text-green-600 ml-1">{{ formatQuantity(product.sold, product.product) }}</span>
            </div>
            <div>
              <span class="text-gray-600">Returned:</span>
              <span class="font-semibold text-orange-600 ml-1">{{ formatQuantity(product.returned, product.product)
                }}</span>
            </div>
            <div>
              <span class="text-gray-600">Remaining:</span>
              <span class="font-semibold text-purple-600 ml-1">{{ formatQuantity(product.remaining, product.product)
                }}</span>
            </div>
          </div>

          <div class="mt-3 pt-3 border-t space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-sm">Sales Value:</span>
              <span class="font-bold text-green-600">{{ product.salesValue | currency:'KES':'symbol':'1.2-2' }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-sm">Returns Value:</span>
              <span class="font-bold text-orange-600">{{ product.returnsValue | currency:'KES':'symbol':'1.2-2'
                }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-sm">Remaining Value:</span>
              <span class="font-bold text-purple-600">{{ product.remainingValue | currency:'KES':'symbol':'1.2-2'
                }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="summary.productSummaries.length === 0" class="text-center py-8 text-gray-500">
          <i class="pi pi-inbox text-5xl mb-2"></i>
          <p>No products allocated</p>
        </div>
      </div>
    </p-card>

    <!-- Financial Summary -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4 border-b">
          <h2 class="text-lg md:text-xl font-bold text-gray-800">Financial Summary</h2>
        </div>
      </ng-template>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="p-4 space-y-3">
        <app-loader-skeleton *ngFor="let _ of [].constructor(6)"></app-loader-skeleton>
      </div>

      <!-- Loaded State -->
      <div *ngIf="!isLoading && summary" class="p-4 space-y-3">
        <!-- Sales Section -->
        <div class="space-y-2">
          <div class="flex justify-between items-center py-2">
            <span class="text-gray-700 font-medium">Gross Sales</span>
            <span class="font-semibold text-lg">{{ summary.grossSales | currency:'KES':'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 text-orange-600">
            <span class="font-medium">Returns Value</span>
            <span class="font-semibold">- {{ summary.returnsValue | currency:'KES':'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 border-t border-gray-200">
            <span class="text-gray-700 font-semibold">Net Sales</span>
            <span class="font-bold text-lg text-green-600">{{ summary.netSales | currency:'KES':'symbol':'1.2-2'
              }}</span>
          </div>
        </div>

        <!-- Expenses Section -->
        <div class="space-y-2 pt-3 border-t border-gray-300">
          <div class="flex justify-between items-center py-2 text-red-600">
            <span class="font-medium">Company Expenses</span>
            <div class="text-right">
              <div class="font-semibold">- {{ summary.companyExpenses | currency:'KES':'symbol':'1.2-2' }}</div>
              <div *ngIf="summary.pendingCompanyExpenses > 0" class="text-xs text-yellow-600">
                ({{ summary.pendingCompanyExpenses | currency:'KES':'symbol':'1.2-2' }} pending)
              </div>
            </div>
          </div>
          <div class="flex justify-between items-center py-2 border-t border-gray-200">
            <span class="text-gray-700 font-semibold">Net After Expenses</span>
            <span class="font-bold text-lg text-blue-600">{{ summary.netSalesAfterCompanyExpenses |
              currency:'KES':'symbol':'1.2-2' }}</span>
          </div>
        </div>

        <!-- Commission Section -->
        <div class="space-y-2 pt-3 border-t border-gray-300">
          <div class="flex justify-between items-center py-2 bg-green-50 px-3 rounded">
            <span class="text-green-700 font-medium">Commission ({{ summary.commissionRate }}%)</span>
            <span class="font-bold text-green-600">{{ summary.commissionEarned | currency:'KES':'symbol':'1.2-2'
              }}</span>
          </div>
          <div class="flex justify-between items-center py-2 text-orange-600">
            <span class="font-medium">Personal Expenses</span>
            <div class="text-right">
              <div class="font-semibold">- {{ summary.personalExpenses | currency:'KES':'symbol':'1.2-2' }}</div>
              <div *ngIf="summary.pendingPersonalExpenses > 0" class="text-xs text-yellow-600">
                ({{ summary.pendingPersonalExpenses | currency:'KES':'symbol':'1.2-2' }} pending)
              </div>
            </div>
          </div>
        </div>


        <!-- Final Settlement -->
        <div class="space-y-3 pt-4 border-t-2 border-gray-400">
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-2">
              <span class="text-blue-900 font-bold text-base md:text-lg">Amount to Submit</span>
              <span class="text-2xl md:text-3xl font-bold text-blue-600">
                {{ summary.amountToSubmit | currency:'KES':'symbol':'1.2-2' }}
              </span>
            </div>
            <p class="text-xs text-blue-700">Submit this amount to the company</p>
          </div>

          <div [ngClass]="summary.creditBalance >= 0 ? 'bg-green-50' : 'bg-red-50'" class="p-4 rounded-lg">
            <div class="flex justify-between items-center mb-2">
              <span [ngClass]="summary.creditBalance >= 0 ? 'text-green-900' : 'text-red-900'"
                class="font-bold text-base md:text-lg">
                {{ getCreditBalanceLabel(summary.creditBalance) }}
              </span>
              <span class="text-2xl md:text-3xl font-bold" [ngClass]="getCreditBalanceClass(summary.creditBalance)">
                {{ summary.distributorTakesHome | currency:'KES':'symbol':'1.2-2' }}
              </span>
            </div>
            <p class="text-xs" [ngClass]="summary.creditBalance >= 0 ? 'text-green-700' : 'text-red-700'">
              <span *ngIf="summary.creditBalance >= 0">Your commission after personal expenses</span>
              <span *ngIf="summary.creditBalance < 0">You owe the company this amount</span>
            </p>
          </div>
        </div>

        <!-- Payment Method Breakdown -->
        <div class="space-y-3 pt-4 border-t-2 border-gray-300">
          <h3 class="font-bold text-gray-800 mb-2">Money Received</h3>

          <!-- M-Pesa Total -->
          <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border-2 border-green-300">
            <div class="flex justify-between items-center">
              <span class="text-green-900 font-bold text-lg flex items-center gap-2">
                <i class="pi pi-mobile text-2xl"></i>
                M-Pesa Total
              </span>
              <span class="text-2xl font-bold text-green-700">
                {{ summary.mpesaTotal | currency:'KES':'symbol':'1.2-2' }}
              </span>
            </div>

            <!-- M-Pesa Breakdown -->
            <div class="mt-3 pt-3 border-t border-green-300 space-y-2 text-sm">
              <div class="flex justify-between items-center text-green-800">
                <span class="pl-4">• M-Pesa Deposit</span>
                <span class="font-semibold">{{ summary.mpesaDepositReceived | currency:'KES':'symbol':'1.2-2' }}</span>
              </div>
              <div class="flex justify-between items-center text-green-800">
                <span class="pl-4">• Till Number</span>
                <span class="font-semibold">{{ summary.tillNumberReceived | currency:'KES':'symbol':'1.2-2' }}</span>
              </div>
              <div class="flex justify-between items-center text-green-800">
                <span class="pl-4">• Send Money</span>
                <span class="font-semibold">{{ summary.sendMoneyReceived | currency:'KES':'symbol':'1.2-2' }}</span>
              </div>
              <div *ngIf="summary.mpesaExpenses > 0"
                class="flex justify-between items-center text-red-700 border-t border-green-300 pt-2">
                <span class="pl-4">• Expenses Paid</span>
                <span class="font-semibold">- {{ summary.mpesaExpenses | currency:'KES':'symbol':'1.2-2' }}</span>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t-2 border-green-400">
              <div class="flex justify-between items-center">
                <span class="text-green-900 font-bold">Net M-Pesa Balance</span>
                <span class="text-xl font-bold text-green-800">
                  {{ (summary.mpesaTotal - summary.mpesaExpenses) | currency:'KES':'symbol':'1.2-2' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Cash -->
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border-2 border-blue-300">
            <div class="flex justify-between items-center">
              <span class="text-blue-900 font-bold text-lg flex items-center gap-2">
                <i class="pi pi-money-bill text-2xl"></i>
                Cash
              </span>
              <span class="text-2xl font-bold text-blue-700">
                {{ summary.cashReceived | currency:'KES':'symbol':'1.2-2' }}
              </span>
            </div>
            <div *ngIf="summary.cashExpenses > 0" class="mt-3 pt-3 border-t border-blue-300 space-y-2 text-sm">
              <div class="flex justify-between items-center text-red-700">
                <span class="pl-4">• Expenses Paid</span>
                <span class="font-semibold">- {{ summary.cashExpenses | currency:'KES':'symbol':'1.2-2' }}</span>
              </div>
            </div>

            <div class="mt-3 pt-3 border-t-2 border-blue-400">
              <div class="flex justify-between items-center">
                <span class="text-blue-900 font-bold">Net Cash Balance</span>
                <span class="text-xl font-bold text-blue-800">
                  {{ (summary.cashReceived - summary.cashExpenses) | currency:'KES':'symbol':'1.2-2' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </p-card>

  </div>
</div>